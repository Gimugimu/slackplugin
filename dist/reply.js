!function(e){var t={};function a(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(s,n,function(t){return e[t]}.bind(null,n));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=8)}({0:function(module,__webpack_exports__,__webpack_require__){"use strict";const PREFIX="wamei:";class Util{getUserIdFromMessage(e){for(e=e.closest(".c-virtual_list__item, ts-message");;){let t=e.find(".c-message__gutter a.c-avatar, a.c-message_kit__avatar, a.member_image").attr("href");if(t)return t.split("/")[2];if(0==(e=e.prev()).length)return null}}getMessageUriFromMessage(e){return e.closest(".c-virtual_list__item, ts-message").find("a.c-timestamp, a.timestamp").attr("href")}createMessageLink(e,t,a){return`&lt;${e}|Re:&gt; <span data-id="${t}" data-label="@${a}" spellcheck="false" class="c-member_slug c-member_slug--link ts_tip_texty">@${a}</span>`}getTSfromUri(e){let t=e.match(/\/archives\/.+\/p(\d+)(\?thread_ts=(\d+\.\d+))?.*/);if(t[3])return t[3];if(t[1]){let e=t[1];return`${e.slice(0,e.length-6)}.${e.slice(-6)}`}return null}getUserByUserId(e){let t,a=(t=0==e.indexOf("B")?TS.model.bots:TS.model.members).filter(t=>t.id==e);return 0==a.length?null:((a=a[0]).is_bot=!(!1===a.is_bot),a.display_name=a._display_name_normalized_lc||a._real_name_normalized_lc||a.name,a.avatar_icon=a.is_bot?a.icons.image_36:a.profile.image_24,a)}getUserByName(e){let t;return 0==(t=TS.model.members.filter(t=>t._display_name_normalized_lc==e||t._real_name_normalized_lc==e)).length&&(t=TS.model.bots.filter(t=>t.name==e)),0==t.length?null:((t=t[0]).is_bot=!(!1===t.is_bot),t.display_name=t._display_name_normalized_lc||t._real_name_normalized_lc||t.name,t.avatar_icon=t.is_bot?t.icons.image_36:t.profile.image_24,t)}executeOnLoad(target,callback){const checker=()=>{let loaded=eval(target);return loaded?callback(loaded):setTimeout(checker,1)};checker()}delegate(e,t,a,s){e.addEventListener(t,e=>{const t=e.target.closest(a);t&&s(e,t)})}get settings(){return{set(e,t){try{localStorage.setItem(PREFIX+e,JSON.stringify(t))}catch(e){}},get(e){try{const t=localStorage.getItem(PREFIX+e);return null==t?null:JSON.parse(t)}catch(e){return null}}}}}const util=new Util;__webpack_exports__.a=util},1:function(e,t,a){"use strict";a.d(t,"a",function(){return s});class s{constructor(e){this.target=e}get $input(){return $(this.target).find(".ql-editor")}focus(){const e=this.$input.get(0),t=document.createRange(),a=window.getSelection();t.setStartAfter(e.lastChild),t.collapse(!0),a.removeAllRanges(),a.addRange(t),e.focus()}normalize(e){return e.replace(/(<\/blockquote>)/g,"$1\n").replace(/<br>/g,"\n")}convertNewline(e){return"<p>"+e.replace(/\n/g,"</p><p>")+"</p>"}quoteText(e){return(">"+e.replace(/\n/g,"\n>").replace(/<.+?>/g,"")).replace(/>http/g,"> http")}isEmpty(){return this.$input.is(".ql-blank")}clear(){this.$input.empty()}appendText(e){this.$input.append(this.convertNewline(this.normalize(e)))}appendQuotedText(e){this.$input.append(this.convertNewline(this.quoteText(this.normalize(e))))}}},8:function(e,t,a){"use strict";a.r(t);class s{constructor(e,t,a,s){this.userId=e,this.messageUri=t,this.wholeMessage=a,this.relatedInput=s,this.selectedMessage=""}}var n=a(0);var i=new class{constructor(){this.classAdded="wamei-added",this.buttons=[],this.mount()}append(e){return this.buttons.unshift(e),this}mount(){return n.a.delegate(document,"mouseover","div.c-message",(e,t)=>{this.applyButtons($(t).find("div.c-message_actions__container"),"#msg_input")}),n.a.delegate(document,"mouseover","div.c-message_kit__message",(e,t)=>{const a=$(t.closest("div.c-virtual_list__scroll_container")).find("div.p-message_input");this.applyButtons($(t).find("div.c-message_actions__container"),a)}),n.a.delegate(document,"mouseover","ts-message",(e,t)=>{const a=$(t.closest("div.thread_body_container")).find("div.message_input");this.applyButtons($(t).find("div.action_hover_container"),a)}),this}applyButtons(e,t){e.not(`:has(.${this.classAdded})`).addClass(this.classAdded).each((e,a)=>{const i=$(a),r=i.closest(".c-virtual_list__item, ts-message"),o=n.a.getUserIdFromMessage(r);let l=r.find(".c-message__body, .c-message_kit__text").html();l||(l=r.find(".message_body").html().replace('<span class="constrain_triple_clicks"></span>',"").trim()||""),l=l.replace(/<a href="(https:\/\/.+?)" .+?>Re:<\/a><a .+?>@(.+?)<\/a>/gm,n.a.createMessageLink("$1",o,"$2"));let c="";r.find(".c-message__attachments, .c-message_kit__attachments").not(":has(.c-message_attachment__delete)").find(".c-message_attachment__body .c-message_attachment__row").each((e,t)=>{c+=`\n> ${$(t).html()}`;const a=$(t).find("a.c-message_attachment__title_link");a.length>0&&(c+=`\n> ${a.attr("href")}`)});const d=n.a.getMessageUriFromMessage(r),p=new s(o,d,l+c,t);this.buttons.forEach(e=>{const t=e.createElement(p);t.on("mousedown",()=>{p.selectedMessage=window.getSelection().toString()||""}),e.isAvailable(p)&&i.prepend(t)})})}},r=a(1);class o{constructor(e,t,a){this.selectorMessage=".c-virtual_list__item",this.label=e,this.iconClass=t,this.callback=a}isAvailable(e){return!0}createElement(e){const t=$(`<button class="wamei-added btn_msg_action c-button-unstyled c-message_actions__button ${this.label}" type="button" aria-haspopup="true" aria-label="${this.label}"><i class="c-icon ${this.iconClass}" aria-hidden="true"></i></button>`).click(()=>{this.callback(e)}).hover(()=>{const e=t.offset(),a=$(`<div class="ReactModal__Content ReactModal__Content--after-open popover" tabindex="-1" aria-label="popover" style="position: absolute; left: ${e.left}px; top: ${e.top}px; outline: none; z-index:100000;"><div><div class="c-tooltip__tip c-tooltip__tip--top" data-qa="tooltip-tip">${this.label}<div class="c-tooltip__tip__arrow"></div></div></div></div>`).hide();$(document.body).append($(`<div class="ReactModalPortal" id="${this.label}-tooltip"></div>`).append('<div class="ReactModal__Overlay ReactModal__Overlay--after-open c-popover c-popover--no-pointer c-popover--z_below_menu c-popover--fade" aria-modal="true"></div>').append(a)),a.css("left",e.left-a.width()/2+20).css("top",e.top-a.height()).fadeIn(200)},()=>{$(`#${this.label}-tooltip`).remove()});return t}}!function(){const e=new o("メッセージを引用する","ts_icon_quote",function(e){const t=new r.a(e.relatedInput);if(t.isEmpty()&&t.clear(),null!=e.userId){const a=n.a.getUserByUserId(e.userId);a&&t.appendQuotedText(`*${a.display_name}*`)}""!=e.selectedMessage?t.appendQuotedText(`${e.selectedMessage}`):t.appendQuotedText(`${e.wholeMessage}`),t.appendText(""),t.focus()}),t=new o("メッセージに返信する",'c-icon--share-action" style="transform: scale(-1, 1);"',function(e){const t=new r.a(e.relatedInput),a=n.a.getUserByUserId(e.userId);if(!a)return;t.isEmpty()&&t.clear();const s=0==e.messageUri.indexOf("/")?location.origin+e.messageUri:e.messageUri;t.appendText(n.a.createMessageLink(s,e.userId,a.display_name)),""!=e.selectedMessage&&t.appendQuotedText(`${e.selectedMessage}`),t.appendText(""),t.focus()});t.isAvailable=function(e){return!!e.userId},i.append(t),i.append(e);const a="wamei-quote-icon-treated";n.a.executeOnLoad("document.querySelector('div#messages_container')",e=>{new MutationObserver(e=>{e.forEach(e=>{$(".c-message__broadcast_preamble").css("font-size","10px"),$(".c-message__broadcast_preamble_link").css("color","#717274"),$(`.c-message blockquote b:not(.${a}), .message_body .special_formatting_quote b:not(.${a})`).each((e,t)=>{const s=$(t),i=s.text();s.addClass(a);const r=n.a.getUserByName(i);r&&s.html(`<img class="c-message_attachment__author_icon" alt="${r.display_name}" src="${r.avatar_icon}" width="16" height="16">${r.display_name}`)})})}).observe(e,{childList:!0,subtree:!0})}),n.a.executeOnLoad("XMLHttpRequest.prototype.open",()=>{const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(a,s){return s.startsWith("/api/chat.postMessage")&&(this.send=function(e){if("message"!=e.get("type"))return t.call(this,e);const a=e.get("text"),s=/&lt;(.*(\/archives\/.+)\|Re:)&gt;/;let i=a.match(s);if(i){e.get("thread_ts")||(e.append("thread_ts",n.a.getTSfromUri(i[2])),e.append("reply_broadcast","true")),e.delete("text"),e.append("text",a.replace(s,"<$1>")),e.append("unfurl_links","false")}return t.call(this,e)}),e.apply(this,arguments)}})}()}});