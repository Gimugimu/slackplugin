// ==UserScript==
// @name         wamei-plugins
// @namespace    wamei
// @version      0.1
// @author       wamei
// @match        https://*.slack.com/*
// @require https://code.jquery.com/jquery-3.4.1.min.js
// ==/UserScript==

!function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=9)}([function(module,__webpack_exports__,__webpack_require__){"use strict";const PREFIX="wamei:";class Util{getUserIdFromMessage(e){for(e=e.closest(".c-virtual_list__item, ts-message");;){let t=e.find(".c-message__gutter a.c-avatar, a.c-message_kit__avatar, a.member_image").attr("href");if(t)return t.split("/")[2];if(0==(e=e.prev()).length)return null}}getMessageUriFromMessage(e){return e.closest(".c-virtual_list__item, ts-message").find("a.c-timestamp, a.timestamp").attr("href")}createMessageLink(e,t,s){return`&lt;${e}|Re:&gt; <span data-id="${t}" data-label="@${s}" spellcheck="false" class="c-member_slug c-member_slug--link ts_tip_texty">@${s}</span>`}getTSfromUri(e){let t=e.match(/\/archives\/.+\/p(\d+)(\?thread_ts=(\d+\.\d+))?.*/);if(t[3])return t[3];if(t[1]){let e=t[1];return`${e.slice(0,e.length-6)}.${e.slice(-6)}`}return null}getUserByUserId(e){let t,s=(t=0==e.indexOf("B")?TS.model.bots:TS.model.members).filter(t=>t.id==e);return 0==s.length?null:((s=s[0]).is_bot=!(!1===s.is_bot),s.display_name=s._display_name_normalized_lc||s._real_name_normalized_lc||s.name,s.avatar_icon=s.is_bot?s.icons.image_36:s.profile.image_24,s)}getUserByName(e){let t;return 0==(t=TS.model.members.filter(t=>t._display_name_normalized_lc==e||t._real_name_normalized_lc==e)).length&&(t=TS.model.bots.filter(t=>t.name==e)),0==t.length?null:((t=t[0]).is_bot=!(!1===t.is_bot),t.display_name=t._display_name_normalized_lc||t._real_name_normalized_lc||t.name,t.avatar_icon=t.is_bot?t.icons.image_36:t.profile.image_24,t)}executeOnLoad(target,callback){const checker=()=>{let loaded=eval(target);return loaded?callback(loaded):setTimeout(checker,1)};checker()}delegate(e,t,s,a){e.addEventListener(t,e=>{const t=e.target.closest(s);t&&a(e,t)})}onElementInserted(e,t){this.elementInsertedSelector||(this.elementInsertedSelector={},$("head").append("<style>@-webkit-keyframes elementInserted { 0% {opacity: 0;} 100% {opacity: 1;} }</style>")),this.elementInsertedSelector[e]||(this.elementInsertedSelector[e]=[],$("head").append(`<style>${e} { -webkit-animation: elementInserted 0.001s 1; }</style>`),document.addEventListener("webkitAnimationStart",t=>{"elementInserted"==t.animationName&&this.elementInsertedSelector[e].forEach(e=>{e(t)})})),this.elementInsertedSelector[e].push(t)}get settings(){return{set(e,t){try{localStorage.setItem(PREFIX+e,JSON.stringify(t))}catch(e){}},get(e){try{const t=localStorage.getItem(PREFIX+e);return null==t?null:JSON.parse(t)}catch(e){return null}}}}}const util=new Util;__webpack_exports__.a=util},function(e,t,s){"use strict";s.d(t,"a",function(){return a});class a{constructor(e){this.target=e}get $input(){return $(this.target).find(".ql-editor")}focus(){const e=this.$input.get(0),t=document.createRange(),s=window.getSelection();t.setStartAfter(e.lastChild),t.collapse(!0),s.removeAllRanges(),s.addRange(t),e.focus()}normalize(e){return e.replace(/(<\/blockquote>)/g,"$1\n").replace(/<br>/g,"\n")}convertNewline(e){return"<p>"+e.replace(/\n/g,"</p><p>")+"</p>"}quoteText(e){return(">"+e.replace(/\n/g,"\n>").replace(/<.+?>/g,"")).replace(/>http/g,"> http")}isEmpty(){return this.$input.is(".ql-blank")}clear(){this.$input.empty()}appendText(e){this.$input.append(this.convertNewline(this.normalize(e)))}appendQuotedText(e){this.$input.append(this.convertNewline(this.quoteText(this.normalize(e))))}}},function(e,t,s){"use strict";s.r(t);var a=s(0);!function(){const e=e=>{e.css("background-color","#ddebd7").hover(function(){$(this).css("background-color","#e7efe4")},function(){$(this).css("background-color","#ddebd7")})};a.a.onElementInserted(".c-message, .c-message_kit__message, ts-message",t=>{const s=$(t.target);e(s.has('.message_body a[data-member-id="'+TS.model.user.id+'"]')),e(s.has('.c-message__body a[data-member-id="'+TS.model.user.id+'"]')),e(s.has('.c-message_kit__text a[data-member-id="'+TS.model.user.id+'"]')),e(s.has('.message_body span[data-broadcast-id="BKhere"]')),e(s.has('.c-message__body span[data-broadcast-id="BKhere"]')),e(s.has('.c-message_kit__text span[data-broadcast-id="BKhere"]')),e(s.has('.message_body span[data-broadcast-id="BKchannel"]')),e(s.has('.c-message__body span[data-broadcast-id="BKchannel"]')),e(s.has('.c-message_kit__text span[data-broadcast-id="BKchannel"]'))})}()},function(e,t,s){"use strict";s.r(t);var a=s(0),n=s(1);!function(){const e=new n.a(".c-search__input_box");a.a.executeOnLoad("document.querySelector('div.channel_header')",t=>{new MutationObserver(t=>{t.forEach(t=>{$(t.target).find("div.channel_title_info:not(:has(#search-in-channel))").append($('<button type="button" id="search-in-channel" class="btn_unstyle blue_on_hover channel_actions_toggle channel_header_icon ts_tip ts_tip_bottom"><span class="ts_tip_tip">チャンネル内検索</span><ts-icon class="ts_icon_search_in_channel" aria-hidden="true"></ts-icon></button>').click(()=>{$("#search_container").click(),a.a.executeOnLoad("$('.ReactModal__Content[aria-label=\"検索\"]').length",()=>{const t=TS.model.active_cid;let s="";switch(t.charAt(0)){case"C":s=`#${TS.model.channels.filter(e=>e.id==t)[0].name}`;break;case"G":s=`#${TS.model.groups.filter(e=>e.id==t)[0].name}`;break;case"D":s=`@${TS.model.ims.filter(e=>e.id==t)[0].name}`;break;default:return void e.focus()}e.clear(),e.appendText(`in:${s} `),e.$input.scrollLeft(Number.MAX_SAFE_INTEGER),e.$input.parent().click(),e.focus()})}))})}).observe(t,{childList:!0,subtree:!0})}),$("head").append("<style>.ts_icon_search_in_channel::before { content: '\\E086' }</style>")}()},function(e,t,s){"use strict";s.r(t),s(0).a.executeOnLoad("window.WebSocket.prototype.send",()=>{const e=window.WebSocket.prototype.send;window.WebSocket.prototype.send=function(t){let s=JSON.parse(t);s&&s.type&&"typing"==s.type||e.call(this,t)}})},function(e,t,s){"use strict";s.r(t);var a=s(0);!function(){const e=e=>e?(e>500&&(e=500),$(".client_channels_list_container").css("flex-basis",`${e}px`),$(".p-channel_sidebar").css("width",`${e}px`),$("#col_channels").css("width",`${e}px`),$("#loading-zone").css("left",`${e}px`),e):e,t="sidebar-width",s=a.a.settings.get(t);e(s),a.a.executeOnLoad("$('.p-channel_sidebar__section_heading').length > 0",()=>{e(s);const n=$('<div class="wamei-sidebar-resizer" style="position:absolute;right:-3px;top:0;height:100%;width:3px;cursor:col-resize;z-index:1000;" draggable="true"></div>').on("drag",t=>{e(t.clientX)}).on("dragend",s=>{let n=s.clientX;n=e(n),a.a.settings.set(t,n)});$(".client_channels_list_container").css("max-width","500px").append(n)})}()},function(e,t,s){"use strict";s.r(t);class a{constructor(e,t,s,a){this.userId=e,this.messageUri=t,this.wholeMessage=s,this.relatedInput=a,this.selectedMessage=""}}var n=s(0);var i=new class{constructor(){this.classAdded="wamei-added",this.buttons=[],this.mount()}append(e){return this.buttons.unshift(e),this}mount(){return n.a.delegate(document,"mouseover","div.c-message",(e,t)=>{this.applyButtons($(t).find("div.c-message_actions__container"),"#msg_input")}),n.a.delegate(document,"mouseover","div.c-message_kit__message",(e,t)=>{const s=$(t.closest("div.c-virtual_list__scroll_container")).find("div.p-message_input");this.applyButtons($(t).find("div.c-message_actions__container"),s)}),n.a.delegate(document,"mouseover","ts-message",(e,t)=>{const s=$(t.closest("div.thread_body_container")).find("div.message_input");this.applyButtons($(t).find("div.action_hover_container"),s)}),this}applyButtons(e,t){e.not(`:has(.${this.classAdded})`).addClass(this.classAdded).each((e,s)=>{const i=$(s),r=i.closest(".c-virtual_list__item, ts-message"),o=n.a.getUserIdFromMessage(r);let c=r.find(".c-message__body, .c-message_kit__text").html();c||(c=r.find(".message_body").html().replace('<span class="constrain_triple_clicks"></span>',"").trim()||""),c=c.replace(/<a href="(https:\/\/.+?)" .+?>Re:<\/a><a .+?>@(.+?)<\/a>/gm,n.a.createMessageLink("$1",o,"$2"));let l="";r.find(".c-message__attachments, .c-message_kit__attachments").not(":has(.c-message_attachment__delete)").find(".c-message_attachment__body .c-message_attachment__row").each((e,t)=>{l+=`\n> ${$(t).html()}`;const s=$(t).find("a.c-message_attachment__title_link");s.length>0&&(l+=`\n> ${s.attr("href")}`)});const d=n.a.getMessageUriFromMessage(r),_=new a(o,d,c+l,t);this.buttons.forEach(e=>{const t=e.createElement(_);t.on("mousedown",()=>{_.selectedMessage=window.getSelection().toString()||""}),e.isAvailable(_)&&i.prepend(t)})})}},r=s(1);class o{constructor(e,t,s){this.selectorMessage=".c-virtual_list__item",this.label=e,this.iconClass=t,this.callback=s}isAvailable(e){return!0}createElement(e){const t=$(`<button class="wamei-added btn_msg_action c-button-unstyled c-message_actions__button ${this.label}" type="button" aria-haspopup="true" aria-label="${this.label}"><i class="c-icon ${this.iconClass}" aria-hidden="true"></i></button>`).click(()=>{this.callback(e)}).hover(()=>{const e=t.offset(),s=$(`<div class="ReactModal__Content ReactModal__Content--after-open popover" tabindex="-1" aria-label="popover" style="position: absolute; left: ${e.left}px; top: ${e.top}px; outline: none; z-index:100000;"><div><div class="c-tooltip__tip c-tooltip__tip--top" data-qa="tooltip-tip">${this.label}<div class="c-tooltip__tip__arrow"></div></div></div></div>`).hide();$(document.body).append($(`<div class="ReactModalPortal" id="${this.label}-tooltip"></div>`).append('<div class="ReactModal__Overlay ReactModal__Overlay--after-open c-popover c-popover--no-pointer c-popover--z_below_menu c-popover--fade" aria-modal="true"></div>').append(s)),s.css("left",e.left-s.width()/2+20).css("top",e.top-s.height()).fadeIn(200)},()=>{$(`#${this.label}-tooltip`).remove()});return t}}!function(){const e=new o("メッセージを引用する","ts_icon_quote",function(e){const t=new r.a(e.relatedInput);if(t.isEmpty()&&t.clear(),null!=e.userId){const s=n.a.getUserByUserId(e.userId);s&&t.appendQuotedText(`*${s.display_name}*`)}""!=e.selectedMessage?t.appendQuotedText(`${e.selectedMessage}`):t.appendQuotedText(`${e.wholeMessage}`),t.appendText(""),t.focus()}),t=new o("メッセージに返信する",'c-icon--share-action" style="transform: scale(-1, 1);"',function(e){const t=new r.a(e.relatedInput),s=n.a.getUserByUserId(e.userId);if(!s)return;t.isEmpty()&&t.clear();const a=0==e.messageUri.indexOf("/")?location.origin+e.messageUri:e.messageUri;t.appendText(n.a.createMessageLink(a,e.userId,s.display_name)),""!=e.selectedMessage&&t.appendQuotedText(`${e.selectedMessage}`),t.appendText(""),t.focus()});t.isAvailable=function(e){return!!e.userId},i.append(t),i.append(e);const s="wamei-quote-icon-treated";n.a.onElementInserted(".c-message, .c-message_kit__message, ts-message",e=>{const t=$(e.target);t.find(".c-message__broadcast_preamble").css("font-size","10px"),t.find(".c-message__broadcast_preamble_link").css("color","#717274"),t.find(`blockquote b:not(.${s}), .special_formatting_quote b:not(.${s})`).each((e,t)=>{const a=$(t),i=a.text();a.addClass(s);const r=n.a.getUserByName(i);r&&a.html(`<img class="c-message_attachment__author_icon" alt="${r.display_name}" src="${r.avatar_icon}" width="16" height="16">${r.display_name}`)})}),n.a.executeOnLoad("XMLHttpRequest.prototype.open",()=>{const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(s,a){return a.startsWith("/api/chat.postMessage")&&(this.send=function(e){if("message"!=e.get("type"))return t.call(this,e);const s=e.get("text");let a=s.match(new RegExp("&lt;(.*(/archives/.+)|Re:)&gt;"));if(a){e.get("thread_ts")||(e.append("thread_ts",n.a.getTSfromUri(a[2])),e.append("reply_broadcast","true")),e.delete("text"),e.append("text",s.replace(new RegExp("&lt;(.*(/archives/.+)|Re:)&gt;","gm"),"<$1>")),e.append("unfurl_links","false")}return t.call(this,e)}),e.apply(this,arguments)}})}()},function(e,t,s){"use strict";s.r(t);class a{constructor(e,t){this.url=e,this.user=t,this.initElement()}initElement(){this.$element=$(`\n<div id="fs_modal" role="dialog" tabindex="-1" class="fs_modal_file_viewer active" aria-labelledby="fs_modal_header" style="transition: 200ms;">\n  <div class="contents_container fs_modal_file_viewer_content">\n    <div class="contents">\n      <header class="fs_modal_file_viewer_header external">\n\n        <div class="file_header_detailed" style="margin-left: 5px;">\n          <span class=" member_preview_link member_image thumb_48" data-member-id="${this.user.id}" data-thumb-size="48" style="background-image: url('${this.user.profile.image_48}')" aria-hidden="true">  </span>\n          <h2 class="title no_jumbomoji"></h2>\n          <p class="file_meta">\n            <a href="/team/${this.user.id}" target="/team/${this.user.id}" class="message_sender color_U9S39304X color_684b6c member member_preview_link " data-member-id="${this.user.id}">${this.user._real_name_normalized_lc}</a>\n            <span class="bullet" aria-hidden="true"></span>\n          </p>\n        </div>\n\n        <div class="controls">\n          <a href="${this.url}" rel="noreferrer" target="_blank" class="open_btn control_btn btn_icon btn ts_icon ts_icon_external_link ts_tip ts_tip_bottom">\n            <span class="ts_tip_tip">オリジナルを開く</span>\n          </a>\n          <button id="fs_modal_close_btn" class="close_btn control_btn btn_icon btn ts_icon ts_icon_times ts_tip ts_tip_bottom ts_tip_right">\n            <div class="ts_tip_tip">閉じる\n              <div class="muted_tooltip_info">(esc)</div>\n            </div>\n          </button>\n        </div>\n      </header>\n\n      <div class="viewer" id="fs_modal_image_viewer">\n        <div class="images">\n          <figure class="scaled">\n            <img src="${this.url}" alt="" class="scaled_image no_zoom">\n          </figure>\n          <figure class="actual_pixel">\n            <div class="actual_pixel_center">\n              <img src="${this.url}" alt="" class="actual_pixel_image">\n            </div>\n          </figure>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>`).keydown(e=>(event.preventDefault(),event.stopPropagation(),27===e.keyCode&&this.$element.remove(),!1)),this.$element.find("#fs_modal_close_btn, #fs_modal_image_viewer").click(()=>{this.$element.remove()})}}var n=s(0);!function(){const e=e=>{e.find("a:contains(.png), a:contains(.jpg), a:contains(.jpeg), a:contains(.gif), a:contains(.bmp)").not(".c-message_attachment__image").not(".c-message__file_link").each((e,t)=>{const s=$(t);if(s.next("span.c-message_attachment_inline").length>0)return;const i=s.attr("href"),r=decodeURIComponent(i.replace(/^https:\/\/slack-redir.net\/link\?url=/,""));if(s.parents(".c-message_attachment").find(`.c-message_attachment__image[href="${i}"], .c-message_attachment__image[href="${r}"]`).length>0)return;const o=n.a.getUserIdFromMessage(s);s.after($(`\n<span class="c-message_attachment_inline">\n  <div data-expanded="true" data-qa-expandable-container-is-expanded="true">\n    <a role="link" tabindex="0" target="_blank" class="c-message_attachment__image" href="${r}" rel="noopener noreferrer" style="text-indent: 0;"><img src="${r}" style="max-width: 360px; max-height:210px;"></a>\n  </div>\n</span>`).click(e=>{event.preventDefault(),event.stopPropagation();const t=new a(r,TS.model.members.find(e=>e.id==o));return $("body").append(t.$element),t.$element.get(0).focus(),!1}))})};n.a.onElementInserted(".c-message, .c-message_kit__message, ts-message",t=>{const s=$(t.target);e(s)})}()},,function(e,t,s){"use strict";s.r(t);s(7),s(2),s(6),s(3),s(4),s(5)}]);